{{define "content"}}
  <main class="quote-shell">
    <h1>Cotizador</h1>
    <p class="muted">Completa los datos para calcular el desglose. El cálculo se actualiza automáticamente.</p>

    <div class="quote-grid">
      <section class="card">
        <h2>Entradas</h2>
        <form
          id="quote-form"
          class="form-stack quote-form"
          hx-post="/quote/calc"
          hx-trigger="change, keyup changed delay:300ms"
          hx-target="#breakdown"
          hx-swap="innerHTML"
          hx-indicator="#quote-loading"
        >
          <fieldset class="quote-section">
            <legend class="legend">Item</legend>
            <div class="form-grid form-grid-compact">
              <div class="form-row">
                <label for="material_id">Material</label>
                <select id="material_id" name="material_id" required>
                  {{range .Materials}}
                    <option value="{{.ID}}" {{if eq $.Form.MaterialID .ID}}selected{{end}}>{{.Name}}</option>
                  {{end}}
                </select>
                <p class="help-text">Costo base por kilo definido en /admin/materials.</p>
              </div>

              <div class="form-row">
                <label for="grams">Gramos</label>
                <input id="grams" name="grams" type="number" min="0.01" step="0.01" value="{{printf "%.2f" .Form.Grams}}" required />
              </div>

              <div class="form-row">
                <label for="quantity">Cantidad</label>
                <input id="quantity" name="quantity" type="number" min="1" step="1" value="{{printf "%.0f" .Form.Quantity}}" required />
              </div>
            </div>
          </fieldset>

          <fieldset class="quote-section">
            <legend class="legend">Tiempos y márgenes</legend>
            <div class="form-grid form-grid-compact">
              <div class="form-row">
                <label for="printMinutes">Minutos de impresión</label>
                <input id="printMinutes" name="printMinutes" type="number" min="0" step="0.01" value="{{printf "%.2f" .Form.PrintMinutes}}" required />
              </div>

              <div class="form-row">
                <label for="laborMinutes">Minutos de mano de obra</label>
                <input id="laborMinutes" name="laborMinutes" type="number" min="0" step="0.01" value="{{printf "%.2f" .Form.LaborMinutes}}" required />
              </div>

              <div class="form-row">
                <label for="wastePercent">Merma (%)</label>
                <input id="wastePercent" name="wastePercent" type="number" min="0" max="100" step="0.01" value="{{printf "%.2f" .Form.WastePercent}}" required />
              </div>

              <div class="form-row">
                <label for="marginPercent">Margen (%)</label>
                <input id="marginPercent" name="marginPercent" type="number" min="0" max="100" step="0.01" value="{{printf "%.2f" .Form.MarginPercent}}" required />
              </div>
            </div>
          </fieldset>

          <fieldset class="quote-section">
            <legend class="legend">Logística e impuesto</legend>
            <div class="form-grid form-grid-compact">
              <div class="form-row">
                <label for="shipping_id">Shipping</label>
                <select id="shipping_id" name="shipping_id">
                  <option value="">Sin envío</option>
                  {{range .ShippingRates}}
                    <option value="{{.ID}}" {{if eq $.Form.ShippingID .ID}}selected{{end}}>{{.Scope}} - {{.Country}}{{if .City}} / {{.City}}{{end}} ({{printf "%.2f" .FlatCost}})</option>
                  {{end}}
                </select>
              </div>

              <div class="form-row">
                <label for="packaging_id">Packaging</label>
                <select id="packaging_id" name="packaging_id">
                  <option value="">Sin empaque</option>
                  {{range .PackagingRates}}
                    <option value="{{.ID}}" {{if eq $.Form.PackagingID .ID}}selected{{end}}>{{.Name}} ({{printf "%.2f" .FlatCost}})</option>
                  {{end}}
                </select>
              </div>

              <div class="form-row">
                <label for="taxPercent">Impuesto (%)</label>
                <input id="taxPercent" name="taxPercent" type="number" min="0" max="100" step="0.01" value="{{printf "%.2f" .Form.TaxPercent}}" required />
              </div>

              <div class="form-row form-row-inline">
                <input id="taxEnabled" name="taxEnabled" type="checkbox" value="1" {{if .Form.TaxEnabled}}checked{{end}} />
                <label for="taxEnabled">Incluir impuesto</label>
                <p class="help-text">Si se desactiva, el impuesto será 0.</p>
              </div>
            </div>
          </fieldset>

          <div class="form-separator">
            <p class="help-text">Tip: puedes ajustar cualquier campo y el breakdown se recalcula automáticamente.</p>
          </div>
        </form>
      </section>

      <section class="card" aria-live="polite">
        <h2>Breakdown</h2>
        <p id="quote-loading" class="status status-warn htmx-indicator"><span class="badge badge-warn">[WARN]</span> calculating...</p>
        <div id="breakdown">
          {{template "quote_breakdown" .Breakdown}}
        </div>
      </section>
    </div>

    <p><a href="/">Volver</a></p>
  </main>

  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
{{end}}
